# Paper A（補充後的完整重寫稿｜繁體中文）

## 標題

**超越牛頓極限：以偽瞬態延拓與伴隨梯度回退提升高各向異性 Hamiltonian 約束的全局可解性**
（Beyond the Newtonian Limit: Globalizing Solvability in Highly Anisotropic Hamiltonian Constraints via Pseudo-Transient Continuation and Adjoint Protocols）

---

## 摘要（Abstract）

在數值相對論的初值問題中，極端座標映射（例如雙曲正弦類映射）可用於處理外域無限遠端與邊界配置，但同時會引入顯著的網格拉伸與強各向異性（high anisotropy），使離散化後的橢圓型約束方程在線性化層面出現嚴重的尺度不均衡，進而導致標準牛頓—克雷洛夫（Newton–Krylov）流程在部分區域出現步長崩塌、停滯或難以全局化的現象（可視為一種「信任域縮退／崩塌」的表徵）。

本文研究共形平坦初值設定下的 Hamiltonian 約束
$$
\nabla^2 \psi - \frac{1}{8}\psi R - 2\pi \rho \psi^5 = 0,
$$
並呈現兩項與實作密切相關的觀察：其一，在高各向異性區間（以拉伸率 $\Gamma$ 表徵）中，朴素牛頓流程可能迅速失穩；其二，在特定殘差平台區（residual plateau）內，即便線性子問題被高精度求解，牛頓方向仍可能不再是殘差範數 $|F|$ 的有效下降方向，形成可辨識的全局化障礙（globalization barrier）。

為提升在該類病態區域的可運行性與可解釋性，我們提出一個層級化的全局求解架構。基礎層以**偽瞬態延拓（Pseudo-Transient Continuation, PTC）**配合**幀內重試（In-Frame Retry）**提供「生存性」（failure absorption / robustness）；並加入**尺度自適應的對角預條件**以緩和高各向異性帶來的局部尺度落差與符號風險。當偵測到牛頓方向失效時，則引入以 JAX 自動微分計算 $\phi(\psi)=\frac12|F(\psi)|^2$ 之精確梯度 $g=\nabla\phi=J^T F$ 的**伴隨梯度回退（Adjoint/Exact-Gradient Fallback）**作為高階機制。數值實驗顯示：在同一測試設定下，該回退能在平台區後續推動殘差繼續下降，並在突破後使 Newton–Krylov 再次發揮局部效率。本文因此提供一個以「生存—診斷—突破」為結構的最小可行框架，用於處理高各向異性 Hamiltonian 約束的全局求解挑戰。

---

## 1. 引言（Introduction）

廣義相對論的初值問題（Initial Value Problem）是數值相對論的核心。對於共形平坦的初值資料，Hamiltonian 約束可化為非線性橢圓型方程，例如
$$
\nabla^2 \psi - \frac{1}{8}\psi R - 2\pi \rho \psi^5 = 0,
$$
其中 $\psi$ 為共形因子。為處理外域無限遠端或特定邊界配置，常採用座標映射策略；在本文背景中，以拉伸率 $\Gamma$ 描述其帶來的網格拉伸程度。

當 $\Gamma$ 進入極端區間（例如 $\Gamma \ge 15$），離散系統常呈現質變式困難。這類困難在數值上常表現為：牛頓步長被迫快速縮小、線搜索反覆拒絕、殘差停滯或振盪；在工程語境下可視為一種「信任域縮退／崩塌」現象——並非單純“慢”，而是局部線性化與非線性曲率在強各向異性下產生結構性不相容。

我們將此質變困難概括為兩類互補機制：

1. **線性化有效性下降：** 典型牛頓更新可能過於激進，步長被迫縮小，或失去可接受更新。
2. **全局化障礙（globalization barrier）：** 即使線性子問題求解精確，牛頓方向也可能與 $|F|$ 的下降需求不相容，使得以殘差範數作為 merit 的線搜索失效。

傳統做法常依賴更強的預條件器、信任域或多重網格策略以提升可解性；然而在高各向異性區間，僅靠線性層面的改善並不必然能提供可解釋、可診斷且可持續的收斂行為。本文採取的路徑是：以 PTC 提供可運行的生存底座，並在辨識到「牛頓方向對既定 merit 失效」時，切換到與 merit function 一致的回退方向，以跨越平台區並恢復後續下降。

---

## 2. 方法論（Methodology）

我們在 JAX 上實作無矩陣牛頓—克雷洛夫（JFNK）框架，並採用層級化設計，以兼顧效率、穩健與可診斷性。

### 2.1 求解器層級架構（A Hierarchical Solver Suite）

Koun-GR 概念上可分為：

* **Level 0：固定網格牛頓求解器（Fixed-Grid）**：適用於弱非線性區間，偏向效率。
* **Level 1：變網格牛頓求解器（Variable-Grid）**：適用於一般非線性問題，兼顧幾何映射與收斂速度。
* **Level 2：PTC-GR 求解器（本文核心）**：針對強非線性與高各向異性區間，以生存性與可診斷性為優先。

此分層架構的目的不是宣稱某一層級「唯一可用」，而是確保在不同物理情境下能以最合適的成本—穩健性取捨工作；本文聚焦 Level 2 的關鍵機制。

---

### 2.2 偽瞬態延拓（Pseudo-Transient Continuation, PTC）

我們將原問題 $F(\psi)=0$ 以擬時間形式重寫為
$$
\frac{\partial \psi}{\partial \tau} = -F(\psi).
$$
離散化後，相當於求解帶阻尼的線性化系統
$$
\left(J + \frac{1}{\Delta \tau} I\right)\delta\psi = -F(\psi),
$$
其中 $\Delta\tau$ 為擬時間步長。當 $\Delta\tau$ 較小時，更新行為更接近阻尼下降（保守、穩健）；當 $\Delta\tau$ 逐步增大時，更新行為趨近牛頓（效率提升）。我們以自適應策略調整 $\Delta\tau$（例如成功時緩增、失敗時縮小並立即重試），使算法能在早期以生存性為主、並在可行區域逐步恢復更高效率的局部收斂。

---

### 2.3 尺度自適應對角預條件（Scale-Adaptive Diagonal Preconditioning）

在高各向異性網格中，Jacobian 的局部尺度可能跨越多個數量級，導致 Krylov 內層迭代對局部尺度過敏。為提高線性子問題的可處理性，我們採用尺度自適應的對角預條件器，將局部尺度資訊吸收到近似對角解算中。實作上，預條件器的分母同時包含離散算子對角尺度、非線性質量項的局部尺度，以及 PTC 引入的阻尼項 $\Delta\tau^{-1}$，從而在不同區域自動調節更新的相對尺度。

一個在工程上重要的穩健性處理是：對可能呈現符號翻轉風險的局部對角項採取保守處理（例如以絕對值或局部下界避免分母跨越零）。其目的不是宣稱「保證下降」，而是避免預條件器在局部尺度劇烈變化時意外放大更新或出現符號不穩定，從而提高整體流程的可運行性與可診斷性。

---

### 2.4 幀內重試（In-Frame Retry）與接受準則（Acceptance Criterion）

為避免在病態區域中因單次失敗步而浪費外層迭代，我們採用「幀內重試」：若某次更新使殘差未改善，則在同一外層迭代內立即縮小 $\Delta\tau$ 並重解線性子問題，而非等待下一外層迭代。這種策略在數值上等價於：將「失敗吸收」發生在同一幀內完成，避免外層迭代被失敗步拖慢或被迫在不良狀態上前進。

接受準則方面，在理想的嚴格單調語境下，可採用「只接受殘差下降」的判據；但在高各向異性與浮點噪聲背景下，實作中常需採用近單調（near-monotone）容忍帶（例如允許 $1+ \varepsilon$ 的微小浮動）以避免把純數值噪聲誤判為上升。本文將此視為一種工程上合理的穩健性選擇：其目標不是誇大數學單調性，而是提供一條可控的「不惡化」通道，使求解器在極端區域可持續運行。v1.3.22 的實驗顯示，即使在高拉伸網格下，PTC + 幀內重試的組合能維持穩定運作並吸收多次失敗。

---

### 2.5 進階機制：伴隨協議（The Adjoint Protocol）

*註：本節機制用於處理 PTC 在平台區的停滯，是 v1.3.29 引入的高階/備用特性。*

在 $\Gamma=15$ 的測試設定下，我們觀察到一種可重現的失效模式：在平台區，即便將線搜索步長 $\alpha$ 下探至 $1/64$，牛頓方向仍無法降低殘差範數 $|F|$，其殘差下降比率（BestRatio）維持在 $1.000000$ 附近。此現象表明，牛頓方向在該區域對以 $|F|$ 為 merit 的全局化流程失效，形成 globalization barrier。

為跨越此障礙，我們引入伴隨梯度回退。定義 merit function：
$$
\phi(\psi) = \frac{1}{2}|F(\psi)|^2.
$$
其梯度為
$$
g = \nabla\phi(\psi) = J^T F.
$$
我們利用 JAX 自動微分直接計算 $g$，當偵測到牛頓方向失效時，切換至
$$
dx = -g
$$
並以線搜索決定步長。數學上，在足夠小步長下，$-g$ 為 $\phi$ 的一階下降方向；因此該回退提供一個與 merit function 一致的推進機制，能在平台區內促成後續下降，並在突破後使 Newton–Krylov 再次恢復局部效率。本文將其定位為「高階回退協議」：主要在牛頓方向失效時觸發，而非取代 PTC 的生存性骨架。

---

## 3. 數值實驗與結果（Numerical Experiments）

### 3.1 生存性驗證（Survival Proof）

在 $32^3$ 網格、$\Gamma=15$ 的基準測試中：

* **Naive Newton：** 在該高拉伸設定下迅速失穩。
* **Robust PTC（v1.3.22）：** 可維持穩定運行並下降至 $\sim 10^{-1}$ 級殘差後進入長期平台。此結果支持：PTC + 幀內重試能提供高生存性與失敗吸收能力，但在該設定下未必直接給出高精度殘差壓縮。

（此處插入殘差—迭代曲線與 $\Delta\tau$ 演化曲線。）

---

### 3.2 診斷與突破（Diagnosis and Breakthrough）

針對 $\sim 10^{-1}$ 平台，我們基於 v1.3.26–v1.3.29 的實驗序列進行診斷：

1. **方向失效驗證（v1.3.26）：** 在平台區，即使 $\alpha \to 1/64$，牛頓方向 BestRatio 仍鎖定於 $1.000000$，顯示其對 $|F|$ 下降不再有效。此結果支持「平台源自方向—merit 不匹配」而非單純步長不足。
2. **直覺回退失敗（v1.3.28）：** 以預條件殘差方向 $dx=M^{-1}F$ 作回退時，殘差呈漂移而非穩定下降，顯示直覺型回退不足以跨越平台障礙。
3. **伴隨梯度回退成功（v1.3.29）：** 啟用 $dx=-J^T F$ 後，平台區殘差出現台階式下降，並在台階後使 Newton 步重新可用，形成穩定的混合推進模式。

此結果表明：在高各向異性平台區，困難不僅來自剛性（stiffness），亦來自「方向—merit 不匹配」所導致的 globalization barrier；而引入與 merit 一致的梯度資訊可提供可解釋的突破路徑。

---

## 4. 討論（Discussion）

### 4.1 跨領域可遷移性（Cross-Disciplinary Generalizability）

雖然本文以 Hamiltonian 約束為背景，但 PTC–NK 的設計思想可視為針對一類通用非線性橢圓型 PDE 的求解框架，例如
$$
\nabla \cdot (A(\psi)\nabla \psi) + f(\psi) = 0.
$$
在其他領域中，當幾何拉伸或係數異質性導致類似的全局化障礙時，本文的「生存性底座（PTC + retry）—方向失效診斷（BestRatio）—merit-aware 回退（$-J^T F$）」策略可能具有啟發性。這些領域包含但不限於 Poisson–Boltzmann 類方程與特定流體壓力泊松問題；然而其直接適用性仍需在各領域具體設定下進一步驗證。

---

## 5. 結論（Conclusion）

本文針對高各向異性 Hamiltonian 約束提出一個層級化全局求解架構，並得到以下結論：

1. **生存層（PTC + 幀內重試）：** 可在極端拉伸網格下維持穩定運行，提供失敗吸收與可診斷的推進路徑。
2. **障礙診斷（globalization barrier）：** 在平台區，牛頓方向可能對 $|F|$ 失去下降性，即使線性子問題求解精確亦然。
3. **突破層（伴隨梯度回退）：** 以 JAX AD 計算 $g=J^T F$ 並採用 $dx=-g$ 作為 merit-aware 回退，可在平台區促成殘差後續下降，並在突破後使 Newton–Krylov 再次恢復局部效率。

總結而言，本工作將「高各向異性下的求解停滯」轉化為可辨識、可證偽、可跨越的結構性事件，並提供一個最小可行的混合策略，提升了高拉伸幾何下 Hamiltonian 約束求解的可解釋性與可控性。

---
